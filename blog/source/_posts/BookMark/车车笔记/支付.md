#  微信支付

[官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml)

## 微信小程序支付

### 一、所需参数

1. 应用id：`appid: wx9d399a911e0e7989`
2. 商户id：`mch_id: 1587589461`
3. API key：`apiV3Key: 2c5f0f175c544872bffc0c156945d320`
4. 证书：`private_key_file_path: /apiclient_key.pem`

+ ![image-20220316151028908](https://img-1256282866.cos.ap-beijing.myqcloud.com/image-20220316151028908.png)

  

+ ```
  String getPrivateKey() {
      InputStream resourceAsStream = this.getClass().getResourceAsStream(jsApiPayProperties.getPrivateKeyFilePath());
      return IoUtil.read(resourceAsStream, StandardCharsets.UTF_8);
  }
  ```

5. 证书序列号：`serial_no: 57579DB0FF5250FFEE4948177D842CC27B91F392`
6. 回调地址：`pay_path refund_path`
7. 配置应用：小程序绑定微信支付商户号即可

### 二、交互流程

![img](https://img-1256282866.cos.ap-beijing.myqcloud.com/6_2.png)

### 三、主要接口

1. 下单：`https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi`

   + 入参

     ```
     #原始入参
     {
     	"mchid": "1900006XXX",
     	"out_trade_no": "1217752501201407033233368318",
     	"appid": "wxdace645e0bc2cXXX",
     	"description": "Image形象店-深圳腾大-QQ公仔",
     	"notify_url": "https://weixin.qq.com/",
     	"amount": {
     		"total": 1,
     		"currency": "CNY"
     	},
     	"payer": {
     		"openid": "o4GgauInH_RCEdvrrNGrntXDuXXX"
     	}
     }
     ```

   + 出参

     ```
     #原始出参
     {
     	"prepay_id": "wx26112221580621e9b071c00d9e093b0000"
     }
     #
     ```

2. 支付回调：`mydomain/payment/callback`

3. 退款：`https://api.mch.weixin.qq.com/v3/refund/domestic/refunds`

4. 退款回调：`mydomain/refund/callback`

---

## JSAPI支付（微信浏览器）

### 一、所需参数

1. 应用id：`appid: wx09b697c763df1c8d`
2. 商户id：`app_secret: 3a38e02f0c0abe2f3134bd436675dc1d`
3. API key：`apiV3Key: 2c5f0f175c544872bffc0c156945d320`
4. 证书：`private_key_file_path: /apiclient_key.pem`
5. <font color=red size=5> 配置应用：</font>
   + 支付授权目录：【微信支付商户平台—>产品中心—>开发配置】
   + 设置授权域名：【微信公众平台—>公众号设置—>功能设置】

### 二、交互流程

![img](https://img-1256282866.cos.ap-beijing.myqcloud.com/2_2_4.bmp)

### 三、主要接口（同小程序支付）

1. 下单：`https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi`
   + <font color=red size=5> 入参同小程序（openId获取方式改变）</font>
   + 同小程序
2. 支付回调：`mydomain/payment/callback`
3. 退款：`https://api.mch.weixin.qq.com/v3/refund/domestic/refunds`
4. 退款回调：`mydomain/refund/callback`

---

## H5支付（移动端网页）

### 一、所需参数

1. 应用id：`appid: wx9d399a911e0e7989`
2. 商户id：`mch_id: 1587589461`
3. API key：`apiV3Key: 2c5f0f175c544872bffc0c156945d320`
4. 证书：`private_key_file_path: /apiclient_key.pem`
5. <font color=red size=5> 配置应用：</font>【微信支付商户平台—>产品中心—>H5支付—>申请开通】

### 二、交互流程

![img](https://img-1256282866.cos.ap-beijing.myqcloud.com/7_2.png)

### 三、主要接口

1. 下单`https://api.mch.weixin.qq.com/v3/pay/transactions/h5`

   + <font color=red size=5> 入参（新增场景信息实体）</font>

     ```
     {
     	"mchid": "1900006XXX",
     	"out_trade_no": "H51217752501201407033233368018",
     	"appid": "wxdace645e0bc2cXXX",
     	"description": "Image形象店-深圳腾大-QQ公仔",
     	"notify_url": "https://weixin.qq.com/",
     	"amount": {
     		"total": 1,
     		"currency": "CNY"
     	},
     	"scene_info": {
     		"payer_client_ip": "127.0.0.1",
     		"h5_info": {
     			"type": "Wap"
     		}
     	}
     }
     ```

   + <font color=red size=5> 出参</font>

     ```
     {
     	"h5_url": "https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx2916263004719461949c84457c735b0000&package=2150917749"
     }
     ```

2. 支付回调：`mydomain/payment/callback`

3. 退款：`https://api.mch.weixin.qq.com/v3/refund/domestic/refunds`

4. 退款回调：`mydomain/refund/callback`

