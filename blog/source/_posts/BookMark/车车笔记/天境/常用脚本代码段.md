## 用户中心资源扣减


```
lpush COMSUMPTION_RESOURCE_2_LOG "{\"tenant\": 1,\"user\": 1, \"user_name\": \"admin\", \"consumptions\": -1, \"consumption_time\": \"2022-04-22 14:59:19\"}"

lpush COMSUMPTION_RESOURCE_1_LOG "{\"tenant\": 31, \"user\": 0, \"username\": \"system\", \"resource_bundle_detail\": 12, \"consumptions\": 240, \"consumption_time\": \"2022-04-18 10:11:31\"}"
```

## 理赔查询结果处理

```
RPUSH "nier_risk_claim_result_queue" "{\"query_id\":3,\"related_cases_list\":[{\"certificate_no\":\"410423199704227312\",\"case_num\":6},{\"certificate_no\":\"410423199704227313\",\"case_num\":4}],\"related_cases_details\":{\"nodes\":[{\"claim_no\":\"案件号1\"},{\"certificate_no\":\"410423199704227312\",\"name\":\"宋田野\",\"certificate_type\":\"ID_CARD\"},{\"certificate_no\":\"210222199711144816\",\"name\":\"张三\",\"certificate_type\":\"ID_CARD\"},{\"certificate_no\":\"3102221997111448169\",\"name\":\"李四\",\"certificate_type\":\"ID_CARD\"},{\"certificate_no\":\"610222199711144816\",\"name\":\"鲁智深\",\"certificate_type\":\"ID_CARD\"},{\"claim_no\":\"案件号2\"},{\"certificate_no\":\"410423199704227313\",\"name\":\"潘金莲\",\"certificate_type\":\"ID_CARD\"},{\"certificate_no\":\"410222199711144819\",\"name\":\"李逵\",\"certificate_type\":\"ID_CARD\"},{\"certificate_no\":\"810222199711144816\",\"name\":\"武松\",\"certificate_type\":\"ID_CARD\"},{\"claim_no\":\"案件号3\"},{\"claim_no\":\"案件号4\"},{\"claim_no\":\"案件号5\"}],\"links\":[{\"type\":\"车主\",\"target\":0,\"source\":1},{\"type\":\"报案人\",\"target\":0,\"source\":2},{\"type\":\"投保人\",\"target\":0,\"source\":3},{\"type\":\"三者\",\"target\":0,\"source\":4},{\"type\":\"报案人\",\"target\":5,\"source\":4},{\"type\":\"投保人\",\"target\":5,\"source\":6},{\"type\":\"被保险人\",\"target\":5,\"source\":7},{\"type\":\"驾驶人\",\"target\":5,\"source\":1},{\"type\":\"三者\",\"target\":5,\"source\":8},{\"type\":\"报案人\",\"target\":9,\"source\":6},{\"type\":\"三者\",\"target\":9,\"source\":1},{\"type\":\"车主\",\"target\":10,\"source\":1},{\"type\":\"报案人\",\"target\":10,\"source\":2},{\"type\":\"投保人\",\"target\":10,\"source\":3},{\"type\":\"驾驶人\",\"target\":10,\"source\":7},{\"type\":\"车主\",\"target\":11,\"source\":1},{\"type\":\"三者\",\"target\":11,\"source\":8}]}}"
```

## 用户添加资源

```
HMSET "TENANT_126_RESOURCE_1" "balance" "100" "hset" "TENANT_126_RESOURCE_1" "consumption_mode" "次" "expired_time" "2022-04-11 16:39:47"
```

## clickhouse

```
create database seer_dev;
create table seer_dev.policy
(
    area                           UInt32,
    insurance_company              UInt64,
    last_year_insurance_company Nullable(UInt64),
    accept_insurance_date          Date,
    insurance_channel              UInt16,
    insurance_channel_summary_code UInt16,
    insurance_type Enum8('商业险' = 1, '交强险' = 2),
    sub_area                       UInt32,
    third_area                     UInt32,
    effective_date                 Date,
    expired_date                   Date,
    original_charge                Decimal(18, 2),
    charge                         Decimal(18, 2),
    discount_rate Nullable(Float32),
    ratio Nullable(Float32),
    ncd Nullable(Float32),
    traffic_rate Nullable(Float32),
    auto_license_no Nullable(String),
    vin Nullable(String),
    engine_no Nullable(String),
    auto_type LowCardinality(String),
    auto_type_summary_code         UInt8,
    model_energy_type LowCardinality(String),
    fuel_type Nullable(UInt16),
    ev_or_oil Enum8('新能源' = 1, '油车' = 2),
    sale_price                     Decimal(18, 2),
    regist_date                    Date,
    is_transferred                 UInt8,
    is_new                         UInt8,
    insurance_renewal_flag Nullable(Enum8('新保' = 1, '续保' = 2, '转保' = 3, '其他' = 4)),
    auto_age                       UInt8,
    brand LowCardinality(String),
    brand_code LowCardinality(String),
    family Nullable(String),
    family_code Nullable(String),
    model Nullable(String),
    model_code Nullable(String),
    insurance_model_code Nullable(String),
    use_property                   UInt16,
    use_property_summary_code      UInt16,
    insurance_kind Array(Tuple(String, Decimal(18, 2), Decimal(18, 2), UInt16)),
    vehicle_damage_insured         UInt8,
    vehicle_damage_amount          Decimal(18, 2),
    vehicle_damage_premium         Decimal(18, 2),
    third_party_insured            UInt8,
    third_party_amount             Decimal(18, 2),
    third_party_premium            Decimal(18, 2),
    seat_driver_insured            UInt8,
    seat_driver_amount             Decimal(18, 2),
    seat_driver_premium            Decimal(18, 2),
    seat_passenger_insured         UInt8,
    seat_passenger_amount          Decimal(18, 2),
    seat_passenger_premium         Decimal(18, 2),
    seat_passenger_num Nullable(UInt16),
    auto_owner_type Enum8('个人' = 1, '机关' = 2, '企业' = 3),
    confirm_no                     String,
    certificate_no Nullable(String),
    agent_name Nullable(String),
    third_party_record_code Nullable(String),
    agent_type Nullable(Enum8('个人代理人' = 1, '兼业代理人' = 2, '专业代理人' = 3, '经纪人' = 4)),
    create_time                    DateTime default now(),
    insured_data Array(Tuple(Date, UInt32, Decimal(18, 2))),
    auto_owner_name Nullable(String),
    auto_owner_credential_code Nullable(UInt16),
    auto_owner_credential_no Nullable(String),
    applicant_name Nullable(String),
    applicant_credential_code Nullable(UInt16),
    applicant_credential_no Nullable(String),
    insured_name Nullable(String),
    insured_credential_code Nullable(UInt16),
    insured_credential_no Nullable(String)
)
    engine = MergeTree PARTITION BY area
        ORDER BY (area, sub_area, third_area, insurance_company, insurance_type, confirm_no)
        SETTINGS index_granularity = 8192;

INSERT INTO seer_dev.policy (area, insurance_company, last_year_insurance_company, accept_insurance_date, insurance_channel, insurance_channel_summary_code, insurance_type, sub_area, third_area, effective_date, expired_date, original_charge, charge, discount_rate, ratio, ncd, traffic_rate, auto_license_no, vin, engine_no, auto_type, auto_type_summary_code, model_energy_type, fuel_type, ev_or_oil, sale_price, regist_date, is_transferred, is_new, insurance_renewal_flag, auto_age, brand, brand_code, family, family_code, model, model_code, insurance_model_code, use_property, use_property_summary_code, insurance_kind, vehicle_damage_insured, vehicle_damage_amount, vehicle_damage_premium, third_party_insured, third_party_amount, third_party_premium, seat_driver_insured, seat_driver_amount, seat_driver_premium, seat_passenger_insured, seat_passenger_amount, seat_passenger_premium, seat_passenger_num, auto_owner_type, confirm_no, certificate_no, agent_name, third_party_record_code, agent_type, create_time, insured_data, auto_owner_name, auto_owner_credential_code, auto_owner_credential_no, applicant_name, applicant_credential_code, applicant_credential_no, insured_name, insured_credential_code, insured_credential_no) VALUES (450000, 4005, 2002, '2020-01-09', 13, 3, '交强险', 450600, 450603, '2020-01-31', '2021-01-30', 3478.27, 1862.22, 0.5353864, 0.669233, 0.8, 1, '桂YU2QK1', 'LZDLDMN3PQR074325', '723020', '41', 9, 'C', 10, '油车', 1397313.67, '2011-07-26', 0, 0, '续保', 9, '东风日产', 'SHC', '轩逸', 'SHCLY', '东风日产DFL7168VBL2轿车', 'BSHCLYUC0029', 'BAAAJAUA000190A1', 12, 3, [('200',100000,1243.63,0),('702',50000,1.01,4)], 1, 100000.00, 1243.63, 0, 0.00, 0.00, 0, 0.00, 0.00, 1, 50000.00, 1.01, 4, '个人', '08043c865bc74f5d93cd72b58c4920fc', 'YX211400001202100070', '汇泽保险销售服务有限公司山西分公司', 'CXPTA2018101602', '经纪人', '2022-05-12 04:32:33', [('2020-01-01',1,5.08),('2020-02-01',29,147.55),('2020-03-01',31,157.72),('2020-04-01',30,152.64),('2020-05-01',31,157.72),('2020-06-01',30,152.64),('2020-07-01',31,157.72),('2020-08-01',31,157.72),('2020-09-01',30,152.64),('2020-10-01',31,157.72),('2020-11-01',30,152.64),('2020-12-01',31,157.72),('2021-01-01',30,152.64)], null, null, '111111', null, null, '222222', null, null, '333333');
INSERT INTO seer_dev.policy (area, insurance_company, last_year_insurance_company, accept_insurance_date, insurance_channel, insurance_channel_summary_code, insurance_type, sub_area, third_area, effective_date, expired_date, original_charge, charge, discount_rate, ratio, ncd, traffic_rate, auto_license_no, vin, engine_no, auto_type, auto_type_summary_code, model_energy_type, fuel_type, ev_or_oil, sale_price, regist_date, is_transferred, is_new, insurance_renewal_flag, auto_age, brand, brand_code, family, family_code, model, model_code, insurance_model_code, use_property, use_property_summary_code, insurance_kind, vehicle_damage_insured, vehicle_damage_amount, vehicle_damage_premium, third_party_insured, third_party_amount, third_party_premium, seat_driver_insured, seat_driver_amount, seat_driver_premium, seat_passenger_insured, seat_passenger_amount, seat_passenger_premium, seat_passenger_num, auto_owner_type, confirm_no, certificate_no, agent_name, third_party_record_code, agent_type, create_time, insured_data, auto_owner_name, auto_owner_credential_code, auto_owner_credential_no, applicant_name, applicant_credential_code, applicant_credential_no, insured_name, insured_credential_code, insured_credential_no) VALUES (450000, 4005, 2002, '2020-01-09', 13, 3, '交强险', 450600, 450603, '2020-01-31', '2021-01-30', 3478.27, 1862.22, 0.5353864, 0.669233, 0.8, 1, '桂YU2QK1', 'LZDLDMN3PQR074325', '723020', '41', 9, 'C', 10, '油车', 1397313.67, '2011-07-26', 0, 0, '续保', 9, '东风日产', 'SHC', '轩逸', 'SHCLY', '东风日产DFL7168VBL2轿车', 'BSHCLYUC0029', 'BAAAJAUA000190A1', 12, 3, [('200',100000,1243.63,0),('702',50000,1.01,4)], 1, 100000.00, 1243.63, 0, 0.00, 0.00, 0, 0.00, 0.00, 1, 50000.00, 1.01, 4, '个人', '08043c865bc74f5d93cd72b58c4920fc', 'YX211400001202100070', '汇泽保险销售服务有限公司山西分公司', 'CXPTA2018101602', '经纪人', '2022-05-12 04:32:33', [('2020-01-01',1,5.08),('2020-02-01',29,147.55),('2020-03-01',31,157.72),('2020-04-01',30,152.64),('2020-05-01',31,157.72),('2020-06-01',30,152.64),('2020-07-01',31,157.72),('2020-08-01',31,157.72),('2020-09-01',30,152.64),('2020-10-01',31,157.72),('2020-11-01',30,152.64),('2020-12-01',31,157.72),('2021-01-01',30,152.64)], null, null, '444444', null, null, '111111', null, null, '555555');
```

## 寻找vin码位置

```
class Scrach {
    public static void main(String[] args) {
        //byVin("LBJETVYA39R809561");
        byClaim("996824653315969151");
    }
    static void byVin(String vin) {
        Integer vin_last_5_36_num = Integer.parseInt(vin.substring(vin.length()-5), 36);
        Integer db = vin_last_5_36_num % 8;
        Integer dn = vin_last_5_36_num % 128 / 8;
        System.out.println("vin:"+ db+","+dn);
    }
    static void byClaim(String claim) {
        Long aLong = Long.valueOf(claim);
        Long db = aLong % 8;
        Long dn = aLong % 128 / 8;
        System.out.println(db+","+dn);
    }
}
```

## 概况

```
RPUSH "nier_batch_query_summary_generator_queue" "{\"batch_query_id\":22,\"type\":1,\"vin_list\":[\"LGB622E21DS017242\"]}" "{\"batch_query_id\":21,\"type\":2,\"area\":450000,\"certificate_no\":\"111111\"}"
```

```
RPUSH "nier_batch_query_summary_result_queue" "{\"batch_query_id\":30,\"summary_list\":[{\"query_year\":9999,\"auto_count\":1229,\"case_count\":1,\"insured_premium\":78905.15,\"policy_paid_amount\":2344.12,\"policy_unpaid_amount\":3244.32,\"case_paid_amount\":3423.32,\"case_unpaid_amount\":2543.54,\"average_amount\":3252.45,\"insured_distribution\":\"insuredDistribution\"},{\"query_year\":2023,\"auto_count\":1229,\"case_count\":1,\"insured_premium\":78905.15,\"policy_paid_amount\":2344.12,\"policy_unpaid_amount\":3244.32,\"case_paid_amount\":3423.32,\"case_unpaid_amount\":2543.54,\"average_amount\":3252.45,\"insured_distribution\":\"insuredDistribution\"},{\"query_year\":2021,\"auto_count\":1229,\"case_count\":1,\"insured_premium\":78905.15,\"policy_paid_amount\":2344.12,\"policy_unpaid_amount\":3244.32,\"case_paid_amount\":3423.32,\"case_unpaid_amount\":2543.54,\"average_amount\":3252.45,\"insured_distribution\":\"insuredDistribution\"},{\"query_year\":2022,\"auto_count\":1229,\"case_count\":1,\"insured_premium\":78905.15,\"policy_paid_amount\":2344.12,\"policy_unpaid_amount\":3244.32,\"case_paid_amount\":3423.32,\"case_unpaid_amount\":2543.54,\"average_amount\":3252.45,\"insured_distribution\":\"insuredDistribution\"}]}"
```

```
spring.datasource.clickhouse.jdbc-url = jdbc:clickhouse://cc-2zes4yqt632x140euo.ads.rds.aliyuncs.com:8123/seer_dev?allowMultiQueries=true&useUnicode=true&characterEncoding=UTF-8&useSSL=false&zeroDateTimeBehavior=convertToNull
spring.datasource.clickhouse.driver-class-name = ru.yandex.clickhouse.ClickHouseDriver
spring.datasource.clickhouse.type = com.alibaba.druid.pool.DruidDataSource
spring.datasource.clickhouse.username = seer2_test
spring.datasource.clickhouse.password = 1rFxFpwhfU2C*cWNAPAjx7SsFNsLRZbx
```
