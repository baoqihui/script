# 公告需求设计

---

原型图：[https://4g4w5v.axshare.com](https://4g4w5v.axshare.com/) skysky 

---

路径

current

## 一、表结构

```
-- ----------------------------
-- Table structure for user_read_notice
-- ----------------------------
DROP TABLE IF EXISTS `user_read_notice`;
CREATE TABLE `user_read_notice`  (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user` int NOT NULL COMMENT '用户',
  `notice` bigint NOT NULL COMMENT '公告',
  `tenant_notice` bigint NOT NULL COMMENT '租户公告',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '用户已读公告' ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for notice
-- ----------------------------
DROP TABLE IF EXISTS `notice`;
CREATE TABLE `notice`  (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `title` varchar(15) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '标题',
  `content` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '内容',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '状态（1-未发布 2-已发布）',
  `pre_publish_time` datetime NOT NULL COMMENT '预发布时间',
  `publish_time` datetime NULL DEFAULT NULL COMMENT '实际发布时间',
  `all_tenants` tinyint NOT NULL COMMENT '是否全部租户（0-否 1-是）',
  `platform` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '平台（,拼接的id形式 1-决策 2-风控）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 3 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci COMMENT = '公告' ROW_FORMAT = Dynamic;

-- ----------------------------
-- Table structure for tenant_notice
-- ----------------------------
DROP TABLE IF EXISTS `tenant_notice`;
CREATE TABLE `tenant_notice`  (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `tenant` int NOT NULL COMMENT '租户',
  `notice` bigint NOT NULL COMMENT '公告',
  `platform` tinyint NOT NULL COMMENT '平台（1-决策 2-风控）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 6 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '租户公告' ROW_FORMAT = Dynamic;
```

## 二、存在问题

### 1.产品确认问题

暂无

### 2.技术

+ spring boot

+ Redisson：RDelayedQueue

## 三、接口设计

### 1.后台

1. 租户列表查询`get: /api/tenant`，平台列表查询 （樊喆）
2. 公告列表查询`get: /api/notice` （樊喆）
3. 公告新建`post: /api/notice`：数据保存，发送延时消息 （樊喆）
4. 公告详情`get: /api/notice/{id}/detail`（樊喆）
5. 公告修改`put: /api/notice/{id}`：发布前：删除延时消息，删除tenant_notice记录，重新添加； 发布后：只可修改notice 的title、content； （樊喆）
6. 公告删除`delete: /api/notice/{id}`：不考虑状态，直接删除notice，tenant_notice，user_read_notice；取消延时消息 （樊喆）
5. 延时消息发布/取消 （回宝旗 7.8）

### 2.用户端

1. 公告未读数量`get: /api/notice/{platform}/un_read/num`（回宝旗 7.4）
2. 最近公告查询`get: /api/notice/{platform}/un_read/last `（回宝旗 7.4）
3. 公告列表 `get: /api/notice/{platform} `（回宝旗7.5）
3. 公告详情：与管理端共用
4. 更新已读状态 `post /api/notice/user_read `（回宝旗 7.5）

### 3.公共

+ 数据库设计（6.28）

+ 基础框架搭建 （回宝旗 6.30）
+ Redisson：RDelayedQueue 搭建（回宝旗 7.1）
+ 权限集成 （回宝旗 6.30）
+ 网关

## 四、交互流程图

![image-20220628154206836](https://img-1256282866.cos.ap-beijing.myqcloud.com/image-20220628154206836.png)

