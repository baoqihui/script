# 微信订阅消息定制化

![image-20220330132046796](https://img-1256282866.cos.ap-beijing.myqcloud.com/image-20220330132046796.png)



消息优化上线todo: 

+ 零点前上线：确保奖励到账通知
+ 活动通知-连续三日未申请 发送时间变更 ：`0 3 12 * * ? *` ->`0 16 19 * * ? *`
+ 初始化消息tokenid：`initWechatMessageToken`

```
curl --location --request GET '127.0.0.1:8088/v2.0/initWechatMessageToken' \
--header 'backend-token: 41614634-0c04-4e84-8a0e-db01def48247' \
--header 'Content-Type: application/json' \
--data-raw '[
    {
        "page": "pages/index/index",
        "targetPage": "suspension",
        "messageType": "A1"
    },
    {
        "page": "pages/index/index",
        "targetPage": "suspension",
        "messageType": "B1"
    },
    {
        "page": "pages/index/index",
        "targetPage": "webview",
        "messageType": "B2",
        "url":"https://www.cheche365.com/m/index.html?src=tinggeili"
    },
    {
        "page": "pages/index/index",
        "targetPage": "webview",
        "messageType": "B3",
        "url":"https://channelh5.pubmi.cn/h5/newepidemicDetail?channel=ZT22033002&agentId="
    },
    {
        "page": "pages/index/index",
        "targetPage": "identify-code",
        "messageType": "B4"
    },
    {
        "page": "pages/index/index",
        "targetPage": "invitor",
        "messageType": "B5"
    },
    {
        "page": "pages/index/index",
        "targetPage": "suspension",
        "messageType": "B6"
    },    
    {
        "page": "pages/index/index",
        "targetPage": "suspension",
        "messageType": "C1"
    },
    {
        "page": "pages/index/index",
        "targetPage": "invitor",
        "messageType": "C2"
    },    
    {
        "page": "pages/index/index",
        "targetPage": "webview",
        "messageType": "C3",
        "url":"https://channelh5.pubmi.cn/h5/newepidemicDetail?channel=ZT22033002&agentId="
    },
    {
        "page": "pages/index/index",
        "targetPage": "identify-code",
        "messageType": "C4"
    },
    {
        "page": "pages/index/index",
        "targetPage": "suspension",
        "messageType": "D1"
    }
]'
```

## 一、奖励待领取通知（次日提醒）

1. 触发时间：T+1 12:36
2. 触发条件：

   + 本月停驶天数 < 10
   
   + 订阅用户本月最后一次停驶状态为停驶中
3. 模板id：`P88o-yRmu6CMWpBujUoukrVqYpFgHnDsmb6vn2BJnos`
4. 参数配置：(发送人，达标总天数，最高返现金额，本月停驶天数)

## 二、奖励到账通知

### 定时任务一（奖励变更并存储消息体，需加入用户id）

1. 触发时间：T+2 00:00
2. 触发条件：
   + 本月停驶天数 <= 10
   + 昨日奖励金额到账
3. 模板id：`xpNegMVvwaRCSHGFOB7QUv9c1ak_B2NXBGlouOZClo0`
4. 存储结构：（用户id，变更金额）

### 定时任务二（通过用户获取当日停驶记录发送信息）

1. 触发时间：T+2 09:03

2. 触发条件：redis中存在记录

3. 参数配置：（发送人，变更金额，达标总天数，本月停驶天数，每日返现金额，跳转页面及参数）


## 三、活动通知（三日提醒）

### 定时任务一(扫描三日提醒用户，存储到redis)：

1. 触发时间：T+3 00:00
2. 触发条件：
   + 本月停驶天数<10
   + 当月最后一天不推送该消息类型
3. 存储结构（用户id）

### 定时任务二(发送信息)：

1. 触发时间：T+3 17:36
2. 触发条件：redis中存在记录
3. 模板id：`QEZ8Tj79Jrh9B_LiltMGsr8pDs4mtyM0aUoShefElRQ`
4. 参数配置：（发送人，达标总天数，本月停驶天数，每月最高返现金额，每日返现金额）

