---
title: 备份恢复.md
date:  2022/9/7 12:41
category_bar: true
categories: 运维
tags:
- docker
---
# 备份恢复

## 安装docker

```
apt install -y docker.io
apt install -y docker-compose
```

## 常用脚本

```
#ROOT密码
bash <(curl -Ls https://github.com/baoqihui/script/raw/main/root.sh)
#更新系统
bash <(curl -Ls https://github.com/baoqihui/script/raw/main/init.sh)
#证书申请
bash <(curl -Ls https://github.com/baoqihui/script/raw/main/cert.sh)
```

## 备份

```
#同步工具&压缩工具
apt install -y rclone&&apt install -y zip

#同步配置
mkdir -p /root/.config/rclone&wget -O /root/.config/rclone/rclone.conf https://alist.huijia.cf/d/hui/config/linux/rclone.conf

#下载脚本文件
wget -O /root/backup-rclone.sh https://raw.githubusercontent.com/baoqihui/script/main/my/backup-rclone.sh
wget -O /root/backup-mysql.sh https://raw.githubusercontent.com/baoqihui/script/main/my/backup-mysql.sh
wget -O /root/backup-mysql7.sh https://raw.githubusercontent.com/baoqihui/script/main/my/backup-mysql7.sh
wget -O /root/backup-mysql8.sh https://raw.githubusercontent.com/baoqihui/script/main/my/backup-mysql8.sh

#定时任务每小时刷新
echo "0 */2 * * * bash /root/backup-mysql.sh > /out/backup-mysql.log 2&1 &" >>/var/spool/cron/crontabs/root
echo "2 */2 * * * bash /root/backup-mysql7.sh > /out/backup-mysq7.log 2&1 &" >>/var/spool/cron/crontabs/root
echo "4 */2 * * * bash /root/backup-mysql8.sh > /out/backup-mysql8.log 2&1 &" >>/var/spool/cron/crontabs/root
echo "3 0 * * * bash /root/backup-rclone.sh > /out/backup-rclone.log 2&1 &" >>/var/spool/cron/crontabs/root
```

## 恢复

```
#恢复所有配置文件
bash <(curl -Ls https://raw.githubusercontent.com/baoqihui/script/main/recover-rclone.sh)
#dokcker恢复
wget -O /root/docker-compose.yml https://raw.githubusercontent.com/baoqihui/script/main/my/docker-compose.yml&&docker-compose up -d
#数据库恢复
bash <(curl -Ls https://raw.githubusercontent.com/baoqihui/script/main/reciver-mysql.sh)

#登录mysql刷新权限
docker exec -it mysql8 bash
mysql -uroot -pHBQ521521cf*
update mysql.user set host="%" where user="root";
flush privileges;

#执行逆向mysql
docker exec -it mysql8 bash
cd /out/mysql8/dbscripts/db/scripts/r1.0.4
mysql -uroot -pHBQ521521cf*
source r1.0.4_1.sql
```

## docker-compose常用命令

```
#如果启动时指定-d标志，则以守护进程模式运行服务
docker-compose up -d
#停止所有服务，如果服务没有停止，可以使用docker-compose kill强制杀死服务
docker-compose stop
#删除所有服务
docker-compose rm -f

#启动
docker-compose up 
#如果要批量启动服务（如启动 8 个 Scrapy），则在--scale选项指定服务的个数：
docker-compose up -d --scale spider=8
#列出本地 docker-compose.yml 文件里定义的正在运行的所有服务
docker-compose ps
#查看服务的日志，这个命令会追踪服务的日志文件，类似tail -f命令，使用Ctrl+C退出
docker-compose logs
```

## ServerStatus-Hotaru(探针)

```
wget https://raw.githubusercontent.com/cokemine/ServerStatus-Hotaru/master/status.sh
#服务端
bash status.sh s
#客户端
bash status.sh c
#可通过删除所有下的header去除背景图
/usr/local/ServerStatus/web/css/hotaru_fix.css
#可以修改配置文件手动调整次序
/usr/local/ServerStatus/server/config.json
```

## 流媒体

```
bash <(curl -sSL "https://git.io/JswGm")

INSERT INTO seer_default.`risk_label` (`id`, `description`) VALUES (10, '高速出险');
```

version: '3.3'
services:
  mysql:
    container_name: mysql
    restart: always
    volumes:
      - '/opt/config/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf'
      - '/out/mysql/:/out/mysql/'
    ports:
      - '3306:3306'
    environment:
      - 'MYSQL_ROOT_PASSWORD=biNoQy2rXb4aLUQ'
    image: mysql:5.7.29
  redis:
    container_name: redis
    restart: always
    ports:
      - '6379:6379'
    volumes:
      - 'D:\opt\config\redis.conf:/etc/redis/redis.conf'
    command: redis-server /etc/redis/redis.conf --requirepass HBQ521521cf* --appendonly yes
    image: redis:5.0.3
